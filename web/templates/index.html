<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSFloat Outbid Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        * { transition: background-color 0.2s, border-color 0.2s, color 0.2s; }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }
        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            animation: toast-in 0.3s ease-out;
            cursor: pointer;
            backdrop-filter: blur(8px);
        }
        .toast.removing { animation: toast-out 0.3s ease-in forwards; }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; font-size: 14px; line-height: 1.4; }
        .toast-close { opacity: 0.6; cursor: pointer; padding: 0 4px; }
        .toast-close:hover { opacity: 1; }
        .toast-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .toast-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .toast-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* Tabs */
        .tab-btn { position: relative; }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* Status indicator */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.running { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-dot.stopped { background: #6b7280; }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        .dark .card {
            background: #1f2937;
            border-color: #374151;
        }

        /* Input styling */
        .input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .dark .input {
            background: #374151;
            border-color: #4b5563;
            color: white;
        }
        .dark .input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-success:hover { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transform: translateY(-1px); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-danger:hover { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); transform: translateY(-1px); }
        .btn-ghost {
            background: transparent;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }
        .btn-ghost:hover { background: #f3f4f6; }
        .dark .btn-ghost { color: #9ca3af; border-color: #4b5563; }
        .dark .btn-ghost:hover { background: #374151; }

        /* Table */
        .table-row:hover { background: #f9fafb; }
        .dark .table-row:hover { background: #374151; }

        /* Modal */
        .modal-backdrop {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: modalIn 0.2s ease;
        }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div id="toast-container"></div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
            <div class="flex items-center justify-between h-16">
                <!-- Logo & Status -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <span class="font-semibold text-gray-900 dark:text-white hidden sm:block">CSFloat Bot</span>
                    </div>
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-700">
                        <div id="statusDot" class="status-dot stopped"></div>
                        <span id="botStatus" class="text-sm text-gray-600 dark:text-gray-300">Loading...</span>
                    </div>
                </div>

                <!-- Right side -->
                <div class="flex items-center gap-3">
                    <span id="userInfo" class="text-sm text-gray-500 dark:text-gray-400 hidden sm:block"></span>
                    <a id="adminLink" href="/admin" class="hidden text-gray-500 hover:text-purple-600 dark:text-gray-400 dark:hover:text-purple-400" title="Admin">
                        <i class="fas fa-shield-alt"></i>
                    </a>

                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="w-9 h-9 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700" title="Toggle theme">
                        <i class="fas fa-sun dark:hidden"></i>
                        <i class="fas fa-moon hidden dark:block"></i>
                    </button>

                    <button id="logoutBtn" class="hidden w-9 h-9 rounded-lg flex items-center justify-center text-gray-500 hover:text-red-600 hover:bg-red-50 dark:text-gray-400 dark:hover:text-red-400 dark:hover:bg-red-900/20" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>

                    <!-- Bot Controls -->
                    <div class="flex items-center gap-2 ml-2 pl-4 border-l border-gray-200 dark:border-gray-700">
                        <button id="startBot" class="btn btn-success text-sm py-2 px-4">
                            <i class="fas fa-play text-xs"></i>
                            <span class="hidden sm:inline">Start</span>
                        </button>
                        <button id="stopBot" class="btn btn-danger text-sm py-2 px-4">
                            <i class="fas fa-stop text-xs"></i>
                            <span class="hidden sm:inline">Stop</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
        <!-- Tabs -->
        <div class="flex items-center gap-1 border-b border-gray-200 dark:border-gray-700 mb-6">
            <button class="tab-btn active px-4 py-3 text-sm font-medium text-blue-600 dark:text-blue-400" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" data-tab="accounts">
                <i class="fas fa-user-circle mr-2"></i>Accounts
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" data-tab="orders">
                <i class="fas fa-shopping-cart mr-2"></i>Orders
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" data-tab="history">
                <i class="fas fa-history mr-2"></i>History
            </button>
            <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" data-tab="settings">
                <i class="fas fa-cog mr-2"></i>Settings
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-5">
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Check Interval</div>
                    <div id="checkInterval" class="text-2xl font-semibold text-gray-900 dark:text-white">-</div>
                </div>
                <div class="card p-5">
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Outbid Step</div>
                    <div id="outbidStep" class="text-2xl font-semibold text-gray-900 dark:text-white">-</div>
                </div>
                <div class="card p-5">
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Max Outbids</div>
                    <div id="maxOutbids" class="text-2xl font-semibold text-gray-900 dark:text-white">-</div>
                </div>
                <div class="card p-5">
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Active Orders</div>
                    <div id="totalOrders" class="text-2xl font-semibold text-gray-900 dark:text-white">0</div>
                </div>
            </div>

            <!-- Quick History -->
            <div class="card">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                    <h3 class="font-medium text-gray-900 dark:text-white">Recent Activity</h3>
                </div>
                <div class="p-4">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                <th class="pb-3">Time</th>
                                <th class="pb-3">Item</th>
                                <th class="pb-3">Old</th>
                                <th class="pb-3">New</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity" class="text-sm">
                            <tr><td colspan="4" class="py-8 text-center text-gray-400">No recent activity</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Accounts Tab -->
        <div id="tab-accounts" class="tab-content">
            <div class="card">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="font-medium text-gray-900 dark:text-white">CSFloat Accounts</h3>
                    <button id="addAccountBtn" class="btn btn-primary text-sm py-2">
                        <i class="fas fa-plus text-xs"></i> Add Account
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-100 dark:border-gray-700">
                                <th class="px-4 py-3">Name</th>
                                <th class="px-4 py-3">Status</th>
                                <th class="px-4 py-3">Proxy</th>
                                <th class="px-4 py-3">Last Check</th>
                                <th class="px-4 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTable" class="text-sm">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No accounts yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="tab-orders" class="tab-content">
            <div class="card">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="font-medium text-gray-900 dark:text-white">Active Buy Orders</h3>
                    <button id="refreshOrders" class="btn btn-ghost text-sm py-2">
                        <i class="fas fa-sync text-xs"></i> Sync Orders
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-100 dark:border-gray-700">
                                <th class="px-4 py-3">Item</th>
                                <th class="px-4 py-3">Price</th>
                                <th class="px-4 py-3">Type</th>
                                <th class="px-4 py-3">Float Range</th>
                                <th class="px-4 py-3">Outbids</th>
                                <th class="px-4 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable" class="text-sm">
                            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No active orders</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                    <h3 class="font-medium text-gray-900 dark:text-white">Outbid History</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-100 dark:border-gray-700">
                                <th class="px-4 py-3">Time</th>
                                <th class="px-4 py-3">Item</th>
                                <th class="px-4 py-3">Old Price</th>
                                <th class="px-4 py-3">New Price</th>
                                <th class="px-4 py-3">Competitor</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable" class="text-sm">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No history yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Bot Settings -->
                <div class="card">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                        <h3 class="font-medium text-gray-900 dark:text-white">Bot Settings</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Check Interval (seconds)</label>
                            <input type="number" id="settingInterval" class="input" value="120" min="60">
                            <p class="text-xs text-gray-400 mt-1">Minimum 60 seconds recommended</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Outbid Step ($)</label>
                            <input type="number" step="0.01" id="settingStep" class="input" value="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Max Outbids per Order</label>
                            <input type="number" id="settingMaxOutbids" class="input" value="10">
                        </div>
                    </div>
                </div>

                <!-- Price Ceiling -->
                <div class="card">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                        <h3 class="font-medium text-gray-900 dark:text-white">Price Ceiling</h3>
                        <p class="text-xs text-gray-400 mt-1">Limits based on lowest listing price</p>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Max Multiplier</label>
                            <input type="number" step="0.05" id="settingMultiplier" class="input" value="1.20">
                            <p class="text-xs text-gray-400 mt-1">1.20 = up to 20% above lowest sell price</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Max Premium ($)</label>
                            <input type="number" step="0.50" id="settingPremium" class="input" value="5.00">
                            <p class="text-xs text-gray-400 mt-1">Hard cap above lowest listing</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <button id="saveSettings" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </main>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0" onclick="document.getElementById('addAccountModal').classList.add('hidden')"></div>
        <div class="modal-content card w-full max-w-md relative z-10">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                <h3 class="font-medium text-gray-900 dark:text-white">Add CSFloat Account</h3>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account Name</label>
                    <input type="text" id="newAccountName" class="input" placeholder="My Account">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
                    <input type="text" id="newAccountKey" class="input" placeholder="Your CSFloat API key">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Proxy (optional)</label>
                    <input type="text" id="newAccountProxy" class="input" placeholder="socks5://user:pass@ip:port">
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                <button id="saveAccount" class="btn btn-primary flex-1">Save</button>
                <button id="cancelAccount" class="btn btn-ghost flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'text-blue-600', 'dark:text-blue-400');
                    b.classList.add('text-gray-500', 'dark:text-gray-400');
                });
                btn.classList.add('active', 'text-blue-600', 'dark:text-blue-400');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');

                // Show content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Update status dot based on bot status
        const originalLoadBotStatus = loadBotStatus;
        loadBotStatus = async function() {
            await originalLoadBotStatus();
            const statusText = document.getElementById('botStatus').textContent;
            const dot = document.getElementById('statusDot');
            if (statusText.includes('Running')) {
                dot.classList.remove('stopped');
                dot.classList.add('running');
            } else {
                dot.classList.remove('running');
                dot.classList.add('stopped');
            }
        };

        // Load recent activity for dashboard
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/history?limit=5');
                const history = await response.json();
                const tbody = document.getElementById('recentActivity');

                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-400">No recent activity</td></tr>';
                    return;
                }

                tbody.innerHTML = history.map(h => `
                    <tr class="table-row border-b border-gray-50 dark:border-gray-700/50">
                        <td class="py-3 text-gray-500 dark:text-gray-400">${formatDate(h.timestamp)}</td>
                        <td class="py-3 text-gray-900 dark:text-white truncate max-w-[200px]" title="${h.market_hash_name}">${h.market_hash_name}</td>
                        <td class="py-3 text-gray-500 dark:text-gray-400">${formatPrice(h.old_price_cents)}</td>
                        <td class="py-3 text-green-600 dark:text-green-400 font-medium">${formatPrice(h.new_price_cents)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading recent activity:', e);
            }
        }

        // Update total orders count
        const originalLoadOrders = loadOrders;
        loadOrders = async function() {
            await originalLoadOrders();
            const rows = document.querySelectorAll('#ordersTable tr');
            const count = rows.length > 0 && !rows[0].querySelector('td[colspan]') ? rows.length : 0;
            document.getElementById('totalOrders').textContent = count;
        };

        // Initial load of recent activity
        document.addEventListener('DOMContentLoaded', () => {
            loadRecentActivity();
            setInterval(loadRecentActivity, 60000);
        });
    </script>
</body>
</html>
